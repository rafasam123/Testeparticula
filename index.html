<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<title>Sketch Interativo</title>
<script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
<style>
  body {
    margin: 0; 
    font-family: sans-serif;
    display: flex;
    height: 100vh;
    overflow: hidden;
  }
  #leftPanel {
    width: 50%;
    display: flex;
    flex-direction: column;
    padding: 10px;
    box-sizing: border-box;
    background: #fafafa;
  }
  #codeEditor {
    flex: 1;
    font-family: monospace;
    font-size: 14px;
    padding: 10px;
    border: 1px solid #ccc;
    resize: none;
    background: #fff;
    color: #333;
    overflow: auto;
  }
  .controls {
    margin: 8px 0;
    display: flex;
    gap: 8px;
  }
  button {
    padding: 6px 12px;
    font-size: 14px;
    cursor: pointer;
  }
  #console {
    height: 120px;
    background: #222;
    color: #eee;
    font-family: monospace;
    font-size: 13px;
    padding: 6px;
    overflow-y: auto;
    border-radius: 4px;
    margin-top: 8px;
  }
  #canvasContainer {
    width: 50%;
    background: #ddd;
    display: flex;
    align-items: center;
    justify-content: center;
    box-sizing: border-box;
    padding: 10px;
  }
  canvas {
    border: 1px solid #666;
  }
  #rightPanel {
    width: 25%;
    background: #f4f4f4;
    border-left: 1px solid #ccc;
    box-sizing: border-box;
    padding: 10px;
    display: flex;
    flex-direction: column;
  }
  #notesTabs {
    display: flex;
    gap: 5px;
    margin-bottom: 10px;
    flex-wrap: wrap;
  }
  .noteTab {
    background: #bbb;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
  }
  .noteTab.active {
    background: #6a9ae2;
    color: white;
    font-weight: bold;
  }
  #notesArea {
    flex: 1;
    font-family: monospace;
    font-size: 14px;
    padding: 8px;
    border: 1px solid #ccc;
    resize: none;
    background: white;
    overflow: auto;
  }
  #addNoteBtn {
    margin-top: 8px;
    padding: 6px;
    cursor: pointer;
    background: #6a9ae2;
    color: white;
    border: none;
    border-radius: 4px;
    font-weight: bold;
  }
</style>
</head>
<body>

<div id="leftPanel">
  <h3>C√≥digo do Sketch (JS)</h3>
  <textarea id="codeEditor" spellcheck="false">
// Exemplo padr√£o:
let x = 0;

function setup() {
  createCanvas(700, 400);
  x = 0;
}

function draw() {
  if (!paused) {
    background(240);
    ellipse(x, height / 2, 50, 50);
    x += 2;
    if (x > width) x = 0;
  }
}
  </textarea>
  <div class="controls">
    <button id="runBtn">‚ñ∂Ô∏è Run</button>
    <button id="pauseBtn">‚è∏Ô∏è Pause</button>
    <button id="resetBtn">üîÅ Reset</button>
  </div>
  <div id="console"></div>
</div>

<div id="canvasContainer"></div>

<div id="rightPanel">
  <h3>Notas</h3>
  <div id="notesTabs"></div>
  <textarea id="notesArea" spellcheck="false"></textarea>
  <button id="addNoteBtn">+ Nova Nota</button>
</div>

<script>
  // Vari√°veis globais
  let p5Instance = null;
  let paused = false;

  const canvasContainer = document.getElementById('canvasContainer');
  const codeEditor = document.getElementById('codeEditor');
  const runBtn = document.getElementById('runBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const resetBtn = document.getElementById('resetBtn');
  const consoleDiv = document.getElementById('console');

  // Notas
  const notesTabs = document.getElementById('notesTabs');
  const notesArea = document.getElementById('notesArea');
  const addNoteBtn = document.getElementById('addNoteBtn');
  let notes = [];
  let currentNote = null;

  // Redireciona console.log para nosso consoleDiv
  (function() {
    const origLog = console.log;
    console.log = function(...args) {
      origLog.apply(console, args);
      const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a) : a).join(' ');
      consoleDiv.innerText += msg + '\n';
      consoleDiv.scrollTop = consoleDiv.scrollHeight;
    };
  })();

  function clearConsole() {
    consoleDiv.innerText = '';
  }

  // Fun√ß√£o para substituir chamadas p5 para p.*
  function transformCode(code) {
    const p5Funcs = [
      'createCanvas', 'background', 'ellipse', 'rect', 'line', 'fill', 'noFill', 'stroke', 'noStroke',
      'noLoop', 'loop', 'text', 'textSize', 'textAlign', 'width', 'height',
      'mouseX', 'mouseY', 'frameCount', 'random', 'floor', 'ceil', 'push', 'pop', 'translate', 'rotate'
    ];

    p5Funcs.forEach(fn => {
      if (fn === 'width' || fn === 'height' || fn === 'mouseX' || fn === 'mouseY' || fn === 'frameCount') {
        // propriedades e vari√°veis, substituir somente se n√£o tiver p. na frente
        code = code.replace(new RegExp(`([^\\.])\\b${fn}\\b`, 'g'), `$1p.${fn}`);
      } else {
        // fun√ß√µes
        code = code.replace(new RegExp(`\\b${fn}\\(`, 'g'), `p.${fn}(`);
      }
    });
    return code;
  }

  function runSketch() {
    paused = false;
    clearConsole();

    if (p5Instance) {
      p5Instance.remove();
      p5Instance = null;
    }

    try {
      let userCode = codeEditor.value;

      userCode = transformCode(userCode);

      const sketchFunc = new Function('p', `
        let paused = false;
        ${userCode}
        p.setup = setup;
        p.draw = draw;
        p.keyPressed = typeof keyPressed === 'function' ? keyPressed : undefined;
      `);

      p5Instance = new p5(sketchFunc, canvasContainer);

      console.log('Sketch rodando!');
    } catch (e) {
      console.log('Erro ao executar c√≥digo:', e.message);
    }
  }

  function pauseSketch() {
    if (!p5Instance) return;
    paused = true;
    if (p5Instance.noLoop) p5Instance.noLoop();
    console.log('Sketch pausado');
  }

  function resetSketch() {
    if (!p5Instance) return;
    paused = false;
    // Remove e roda de novo
    p5Instance.remove();
    runSketch();
    console.log('Sketch reiniciado');
  }

  // Controles
  runBtn.onclick = () => {
    paused = false;
    runSketch();
  };

  pauseBtn.onclick = () => {
    pauseSketch();
  };

  resetBtn.onclick = () => {
    resetSketch();
  };

  // --- Notas ---

  function saveCurrentNote() {
    if (currentNote) {
      currentNote.content = notesArea.value;
    }
  }

  function addNote() {
    saveCurrentNote();
    const newNote = { id: Date.now(), title: `Nota ${notes.length + 1}`, content: '' };
    notes.push(newNote);
    currentNote = newNote;
    renderNotesTabs();
    showCurrentNote();
  }

  function selectNote(id) {
    saveCurrentNote();
    currentNote = notes.find(n => n.id === id);
    showCurrentNote();
  }

  function showCurrentNote() {
    if (!currentNote) {
      notesArea.value = '';
      return;
    }
    notesArea.value = currentNote.content;
    updateNotesTabs();
  }

  function renderNotesTabs() {
    notesTabs.innerHTML = '';
    notes.forEach(note => {
      const tab = document.createElement('div');
      tab.className = 'noteTab' + (note.id === currentNote.id ? ' active' : '');
      tab.textContent = note.title;
      tab.onclick = () => selectNote(note.id);
      notesTabs.appendChild(tab);
    });
  }

  function updateNotesTabs() {
    const tabs = notesTabs.children;
    for (let i = 0; i < tabs.length; i++) {
      const tab = tabs[i];
      const note = notes[i];
      if (note.id === currentNote.id) {
        tab.classList.add('active');
      } else {
        tab.classList.remove('active');
      }
    }
  }

  notesArea.addEventListener('input', () => {
    if (currentNote) {
      currentNote.content = notesArea.value;
    }
  });

  addNoteBtn.onclick = addNote;

  // Inicializa com uma nota e com o sketch rodando
  addNote();
  runSketch();

</script>
</body>
</html>
