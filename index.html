<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<title>Mini Editor p5.js com Múltiplos Arquivos</title>
<script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
<style>
  body {
    font-family: monospace;
    margin: 0; padding: 0;
    display: flex; flex-direction: column; height: 100vh;
  }
  #file-tabs {
    display: flex;
    background: #222;
    color: white;
  }
  #file-tabs button {
    background: #333;
    border: none;
    color: white;
    padding: 10px 15px;
    cursor: pointer;
  }
  #file-tabs button.active {
    background: #f90;
    color: black;
  }
  #editor {
    flex-grow: 1;
    width: 100%;
  }
  textarea {
    width: 100%;
    height: 100%;
    font-family: monospace;
    font-size: 14px;
    padding: 10px;
    box-sizing: border-box;
    background: #222;
    color: #eee;
    border: none;
    resize: none;
  }
  #bottom-panel {
    display: flex;
    height: 400px;
    border-top: 2px solid #444;
  }
  #run-btn {
    padding: 10px 15px;
    margin-left: 10px;
    cursor: pointer;
  }
  #sketch-container {
    flex-grow: 1;
    border-left: 2px solid #444;
    background: #fff;
    position: relative;
  }
  #sketch-canvas {
    width: 100%;
    height: 100%;
  }
</style>
</head>
<body>

<div id="file-tabs">
  <button class="active" data-file="sketch1">sketch1.js</button>
  <button data-file="sketch2">sketch2.js</button>
  <button data-file="emitter">emitter.js</button>
  <button id="add-file">➕ Add File</button>
  <button id="run-btn">▶️ Run</button>
</div>

<div id="editor">
  <textarea id="code-area" spellcheck="false"></textarea>
</div>

<div id="bottom-panel">
  <div id="sketch-container"></div>
</div>

<script>
  const tabsContainer = document.getElementById('file-tabs');
  const codeArea = document.getElementById('code-area');
  const sketchContainer = document.getElementById('sketch-container');
  const runBtn = document.getElementById('run-btn');
  const addFileBtn = document.getElementById('add-file');

  // Código dos arquivos iniciais:
  let files = {
    'sketch1': `// sketch1.js
function setup() {
  createCanvas(400, 200);
  background(240);
}

function draw() {
  ellipse(frameCount % width, height/2, 50, 50);
}
`,
    'sketch2': `// sketch2.js
let emitter;

function setup() {
  createCanvas(640, 240);
  emitter = new Emitter(width / 2, 60);
}

function draw() {
  background(255);
  emitter.addParticle();
  let gravity = createVector(0, 0.1);
  emitter.applyForce(gravity);
  emitter.run();
}

class Particle {
  constructor(x, y) {
    this.pos = createVector(x, y);
    this.vel = createVector(random(-1, 1), random(-2, 0));
    this.acc = createVector(0, 0);
    this.lifespan = 255;
  }
  run() {
    this.update();
    this.display();
  }
  applyForce(force) {
    this.acc.add(force);
  }
  update() {
    this.vel.add(this.acc);
    this.pos.add(this.vel);
    this.acc.mult(0);
    this.lifespan -= 4;
  }
  display() {
    noStroke();
    fill(127, this.lifespan);
    ellipse(this.pos.x, this.pos.y, 12);
  }
  isDead() {
    return this.lifespan < 0;
  }
}

class Emitter {
  constructor(x, y) {
    this.origin = createVector(x, y);
    this.particles = [];
  }
  addParticle() {
    this.particles.push(new Particle(this.origin.x, this.origin.y));
  }
  run() {
    for (let i = this.particles.length - 1; i >= 0; i--) {
      this.particles[i].run();
      if (this.particles[i].isDead()) {
        this.particles.splice(i, 1);
      }
    }
  }
  applyForce(force) {
    for (let particle of this.particles) {
      particle.applyForce(force);
    }
  }
}
`,
    'emitter': `// emitter.js
class Emitter {
  constructor(x, y) {
    this.origin = createVector(x, y);
    this.particles = [];
  }

  addParticle() {
    this.particles.push(new Particle(this.origin.x, this.origin.y));
  }

  run() {
    for (let i = this.particles.length - 1; i >= 0; i--) {
      this.particles[i].run();
      if (this.particles[i].isDead()) {
        this.particles.splice(i, 1);
      }
    }
  }
}
`
  };

  let currentFile = 'sketch1';

  // Inicializa editor com código do arquivo atual
  function loadFile(filename) {
    codeArea.value = files[filename] || '';
  }

  // Troca aba
  tabsContainer.addEventListener('click', (e) => {
    if (e.target.tagName === 'BUTTON' && e.target.dataset.file) {
      // Salva conteúdo da aba atual
      files[currentFile] = codeArea.value;

      // Atualiza aba ativa
      [...tabsContainer.querySelectorAll('button')].forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');

      currentFile = e.target.dataset.file;
      loadFile(currentFile);
    }
  });

  // Adicionar novo arquivo
  addFileBtn.onclick = () => {
    const newFileName = prompt("Nome do novo arquivo (ex: 'novo.js'):");
    if (newFileName && !files[newFileName]) {
      files[newFileName] = `// ${newFileName}\n\n`;
      const btn = document.createElement('button');
      btn.textContent = newFileName;
      btn.dataset.file = newFileName;
      btn.classList.add('tab-button');
      tabsContainer.insertBefore(btn, addFileBtn);
      btn.click();
    } else {
      alert('Nome inválido ou arquivo já existe');
    }
  };

  loadFile(currentFile);

  // Função para rodar o sketch no container
  function runSketch() {
    // Salvar código atual
    files[currentFile] = codeArea.value;

    // Montar script concatenando todos os arquivos na ordem (simples)
    let fullCode = `
      let sketch = function(p) {
        ${Object.values(files).join('\n')}
      };
      new p5(sketch, document.getElementById('sketch-container'));
    `;

    // Remover sketch anterior para evitar conflito
    sketchContainer.innerHTML = '';

    // Criar script e injetar
    const script = document.createElement('script');
    script.textContent = fullCode;
    sketchContainer.appendChild(script);
  }

  runBtn.onclick = runSketch;

  // Inicializa com o primeiro sketch rodando
  runSketch();
</script>

</body>
</html>
